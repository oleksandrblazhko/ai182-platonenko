### Перевірка HTTP Verb Tampering

| ID |
| --- |
| WSTG-INPV-03 |

### Резюме
HTTP пропонує низку методів, які можна використовувати для виконання дій на веб-сервері (стандарт HTTP 1.1 називає їх методами, але їх також зазвичай описують як дієслова). Хоча GET і POST на сьогоднішній день є найпоширенішими методами, які використовуються для доступу до інформації, наданої веб-сервером, HTTP допускає кілька інших (і дещо менш відомих) методів. Деякі з них можуть бути використані для підлих цілей, якщо веб-сервер неправильно налаштовано.

RFC 7231 – Протокол передачі гіпертексту (HTTP/1.1): семантика та вміст визначає наступні дійсні методи запиту HTTP або дієслова:
- GET
- HEAD
- POST
- PUT
- DELETE
- CONNECT
- OPTIONS
- TRACE

Однак більшості веб-додатків потрібно лише відповідати на запити GET і POST, отримуючи дані користувача в рядку запиту URL-адреси або додаючи до запиту відповідно. Стандартні посилання в стилі `<a href=""></a>`, а також форми, визначені без методу, запускають запит GET; дані форми, надіслані через `<form method='POST'></form>`, ініціюють запити POST. Виклики JavaScript і AJAX можуть надсилати методи, відмінні від GET і POST, але зазвичай це не потрібно робити. Оскільки інші методи використовуються дуже рідко, багато розробників не знають або не беруть до уваги, як реалізація цих методів веб-сервером або фреймворком програми впливає на функції безпеки програми.

### Цілі тесту
- Перелічіть підтримувані методи HTTP.
- Тест на обхід контролю доступу.
- Перевірте вразливості XST.
- Перевірте методи заміни методів HTTP.

### Як тестувати
#### Відкрийте для себе підтримувані методи
Щоб виконати цей тест, тестувальнику потрібен певний спосіб визначити, які методи HTTP підтримуються веб-сервером, який перевіряється. Хоча метод OPTIONS HTTP забезпечує прямий спосіб зробити це, перевірте відповідь сервера, надсилаючи запити різними методами. Цього можна досягти ручним тестуванням або чимось на зразок сценарію Nmap http-methods.

Щоб використовувати сценарій Nmap `http-methods` для перевірки кінцевої точки `/index.php` на локальному хості сервера за допомогою HTTPS, виконайте команду:

`nmap -p 443 --script http-methods --script-args http-methods.url-path='/index.php' локальний хост`

Під час тестування програми, яка повинна приймати інші методи, напр. RESTful Web Service, ретельно перевірте його, щоб переконатися, що всі кінцеві точки приймають лише ті методи, які їм потрібні.

### Тестування методу PUT
1. Захоплення базового запиту цілі за допомогою веб-проксі.
2. Змініть метод запиту на PUT, додайте файл test.html і надішліть запит на сервер додатків.

`PUT /test.html HTTP/1.1
Хост: веб-сайт testing

<html>
Метод HTTP PUT увімкнено
</html>`

3. Якщо відповідь сервера з кодами успіху 2XX або перенаправленнями 3XX, а потім підтвердьте запит GET для файлу test.html. Програма вразлива.

Якщо метод HTTP PUT не дозволений для базової URL-адреси чи запиту, спробуйте інші шляхи в системі.

> ПРИМІТКА. Якщо ви успішно завантажили веб-оболонку, вам слід перезаписати її або переконатися, що команда безпеки цільової програми знає про це, і видалити компонент негайно після підтвердження концепції.

Використовуючи метод PUT, зловмисник може розмістити в системі довільний і потенційно шкідливий вміст, що може призвести до віддаленого виконання коду, пошкодження сайту або відмови в обслуговуванні.


### Тестування обходу контролю доступу
Знайдіть сторінку для відвідування, яка має таке обмеження безпеки, що запит GET зазвичай змушує перенаправляти 302 на сторінку входу або примусово входити безпосередньо. Надсилайте запити за допомогою різних методів, таких як HEAD, POST, PUT тощо, а також довільно створених методів, таких як BILBAO, FOOBAR, CATS тощо. Якщо веб-програма відповідає HTTP/1.1 200 OK, це не сторінка входу , можна обійти автентифікацію чи авторизацію. У наступному прикладі використовується ncat Nmap.

`$ ncat www.example.com 80
HEAD /admin HTTP/1.1
Host: www.example.com

HTTP/1.1 200 OK
Date: Mon, 18 Aug 2008 22:44:11 GMT
Server: Apache
Set-Cookie: PHPSESSID=pKi...; path=/; HttpOnly
Expires: Thu, 19 Nov 1981 08:52:00 GMT
Cache-Control: no-store, no-cache, must-revalidate, post-check=0, pre-check=0
Pragma: no-cache
Set-Cookie: adminOnlyCookie1=...; expires=Tue, 18-Aug-2009 22:44:31 GMT; domain=www.example.com
Set-Cookie: adminOnlyCookie2=...; expires=Mon, 18-Aug-2008 22:54:31 GMT; domain=www.example.com
Set-Cookie: adminOnlyCookie3=...; expires=Sun, 19-Aug-2007 22:44:30 GMT; domain=www.example.com
Content-Language: EN
Connection: close
Content-Type: text/html; charset=ISO-8859-1`

Якщо система здається вразливою, запустіть CSRF-подібні атаки, як-от наведені нижче, щоб повніше використовувати проблему:

- HEAD /admin/createUser.php?member=myAdmin
- PUT /admin/changePw.php?member=myAdmin&passwd=foo123&confirm=foo123
- CATS /admin/groupEdit.php?group=Admins&member=myAdmin&action=add

Використовуючи наведені вище три команди, змінені відповідно до тестової програми та вимог до тестування, буде створено нового користувача, призначено пароль і призначено користувача адміністратором, і все це за допомогою сліпого подання запиту.

### Тестування потенціалу міжсайтового відстеження
> Примітка: щоб зрозуміти логіку та цілі атаки міжсайтового відстеження (XST), потрібно бути знайомим з атаками міжсайтового сценарію.

Метод TRACE, призначений для тестування та налагодження, дає команду веб-серверу відобразити отримане повідомлення назад клієнту. Цей метод, хоч і здається нешкідливим, у деяких сценаріях може бути успішно використаний для викрадення облікових даних законних користувачів. Цю техніку атаки відкрив Джеремія Гроссман у 2003 році, намагаючись обійти атрибут HttpOnly, який має на меті захистити файли cookie від доступу JavaScript. Однак метод TRACE можна використовувати, щоб обійти цей захист і отримати доступ до cookie, навіть якщо цей атрибут установлено.

Перевірте потенціал міжсайтового відстеження, надіславши такий запит:

`$ ncat www.victim.com 80
TRACE / HTTP/1.1
Host: www.victim.com
Random: Header

HTTP/1.1 200 OK
Random: Header
...`

Веб-сервер повернув 200 і відобразив випадковий заголовок, встановлений на місці. Для подальшого використання цієї проблеми:

`$ ncat www.victim.com 80
TRACE / HTTP/1.1
Host: www.victim.com
Attack: <script>prompt()</script>`

Наведений вище приклад працює, якщо відповідь відображається в контексті HTML.

У старіших браузерах атаки здійснювалися за допомогою технології XHR, яка витоку заголовків, коли сервер відображає їх (наприклад, файли cookie, маркери авторизації тощо), і обхід заходів безпеки, таких як атрибут HttpOnly. Цю атаку можна зняти в останніх браузерах, лише якщо програма інтегрується з технологіями, подібними до Flash.

### Тестування на перевизначення методу HTTP
Деякі веб-фреймворки надають спосіб перевизначити фактичний метод HTTP у запиті, емулюючи відсутні дієслова HTTP, передаючи певний спеціальний заголовок у запитах. Основна мета цього полягає в тому, щоб обійти деякі обмеження проміжного програмного забезпечення (наприклад, проксі, брандмауер), де дозволені методи зазвичай не охоплюють такі дієслова, як PUT або DELETE. Наступні альтернативні заголовки можна використовувати для такого тунелювання дієслів:

- Метод X-HTTP
- Перевизначення методу X-HTTP
- X-метод-перевизначення
Щоб перевірити це, у сценаріях, коли обмежені дієслова, такі як PUT або DELETE, повертають «405 Method not allowed», відтворіть той самий запит із додаванням альтернативних заголовків для перевизначення методу HTTP та спостерігайте, як система відповідає. Програма має відповідати іншим кодом статусу (наприклад, 200) у випадках, коли підтримується заміна методу.

Веб-сервер у наведеному нижче прикладі не дозволяє використовувати метод DELETE і блокує його:

`$ ncat www.example.com 80
DELETE /resource.html HTTP/1.1
Host: www.example.com

HTTP/1.1 405 Method Not Allowed
Date: Sat, 04 Apr 2020 18:26:53 GMT
Server: Apache
Allow: GET,HEAD,POST,OPTIONS
Content-Length: 320
Content-Type: text/html; charset=iso-8859-1
Vary: Accept-Encoding`

Після додавання X-HTTP-заголовка сервер відповідає на запит 200:

`$ ncat www.example.com 80
DELETE /resource.html HTTP/1.1
Host: www.example.com
X-HTTP-Method: DELETE

HTTP/1.1 200 OK
Date: Sat, 04 Apr 2020 19:26:01 GMT
Server: Apache`

### Рекомендацiя
- Переконайтеся, що дозволені лише необхідні заголовки та що дозволені заголовки правильно налаштовано.
- Переконайтеся, що не застосовано жодних обхідних шляхів для обходу заходів безпеки, реалізованих агентами користувача, фреймворками або веб-серверами.




